<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/wasm/perspective-viewer.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" />
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/@finos/perspective/dist/wasm/perspective-server.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" />
        <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/css/themes.css" />
        <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.3/umd/index.min.js"></script>
        <script type="module">
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer@3.4.0/dist/cdn/perspective-viewer.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid@3.4.0/dist/cdn/perspective-viewer-datagrid.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc@3.4.0/dist/cdn/perspective-viewer-d3fc.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-openlayers/dist/cdn/perspective-viewer-openlayers.js";

            import { worker } from "https://cdn.jsdelivr.net/npm/@finos/perspective@3.4.0/dist/cdn/perspective.js";

            const WORKER = await worker();
            const URL = `mta_data.csv`;

            async function get_data() {
                const arrow = localStorage.getItem(URL);
                if (arrow !== null) {
                    console.log("Using cached data from localStorage");
                    try {
                        const buffer = fflate.strToU8(arrow, true);
                        return await WORKER.table(fflate.decompressSync(buffer).buffer);
                    } catch (e) {
                        console.error("Can't load cached data", e);
                        localStorage.clear();
                    }
                }

                console.log("Loading MTA data");
                const resp = await fetch(URL);
                const csv = await resp.text();
                const table = await WORKER.table(csv);
                (async () => {
                    console.log("Caching data");
                    const view = await table.view();
                    const arrow = await view.to_arrow();
                    try {
                        const x = fflate.compressSync(new Uint8Array(arrow));
                        const zipped = fflate.strFromU8(x, true);
                        localStorage.setItem(URL, zipped);
                    } catch (e) {
                        console.error("Can't cache data from data.sfgov.org", e);
                    }
                })();

                return table;
            }

            async function load() {
                const el = document.getElementsByTagName("perspective-viewer")[0];

                const data = get_data();
                const layout_json = await fetch("layout_daily_trend.json");
                const layout = await layout_json.json();

                el.load(await data);
                el.restore(layout);
            }

            load();
        </script>

        <style>
            perspective-viewer {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
            
            .title {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1000;
                background-color: rgba(255, 255, 255, 0.8);
                padding: 5px 10px;
                border-radius: 4px;
                font-family: Arial, sans-serif;
            }
        </style>
    </head>

    <body>
        <div class="title">
            <h2>Daily Traffic Trends by Hour</h2>
        </div>
        <perspective-viewer editable> </perspective-viewer>
    </body>
</html> 