<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/wasm/perspective-viewer.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" />
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/@finos/perspective/dist/wasm/perspective-server.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" />
        <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/css/themes.css" />
        <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.3/umd/index.min.js"></script>
        <script type="module">
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer@3.4.0/dist/cdn/perspective-viewer.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid@3.4.0/dist/cdn/perspective-viewer-datagrid.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc@3.4.0/dist/cdn/perspective-viewer-d3fc.js";
            import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-openlayers/dist/cdn/perspective-viewer-openlayers.js";

            import { worker } from "https://cdn.jsdelivr.net/npm/@finos/perspective@3.4.0/dist/cdn/perspective.js";

            const WORKER = await worker();
            const URL = `mta_data.csv`;

            // This function will process the data and add coordinate info for each region
            async function processData(table) {
                // Create a map of detection regions to coordinates (approximate values for NYC regions)
                const regionCoordinates = {
                    "Brooklyn": { lat: 40.6782, lng: -73.9442 },
                    "Brooklyn Bridge": { lat: 40.7061, lng: -73.9969 },
                    "Manhattan Bridge": { lat: 40.7074, lng: -73.9919 },
                    "East 60th St": { lat: 40.7615, lng: -73.9644 },
                    "FDR Drive": { lat: 40.7520, lng: -73.9715 },
                    "FDR Drive at 60th St": { lat: 40.7616, lng: -73.9588 },
                    "Holland Tunnel": { lat: 40.7277, lng: -74.0089 },
                    "Hugh L. Carey Tunnel": { lat: 40.6901, lng: -74.0145 },
                    "Lincoln Tunnel": { lat: 40.7588, lng: -74.0111 },
                    "New Jersey": { lat: 40.7128, lng: -74.0730 },
                    "Queens": { lat: 40.7282, lng: -73.7949 },
                    "Queens Midtown Tunnel": { lat: 40.7431, lng: -73.9245 },
                    "Queensboro Bridge": { lat: 40.7568, lng: -73.9540 },
                    "West 60th St": { lat: 40.7708, lng: -73.9859 },
                    "West Side Highway": { lat: 40.7863, lng: -73.9868 },
                    "West Side Highway at 60th St": { lat: 40.7723, lng: -73.9903 }
                };

                // Create a view of the data
                const view = await table.view();
                const json = await view.to_json();
                
                // Add longitude and latitude columns
                const processed = json.map(row => {
                    const region = row["Detection Region"];
                    const coords = regionCoordinates[region] || { lat: 40.7128, lng: -74.0060 }; // Default to NYC center
                    
                    return {
                        ...row,
                        "longitude": coords.lng.toString(),
                        "latitude": coords.lat.toString()
                    };
                });
                
                // Create a new table with the processed data
                return await WORKER.table(processed);
            }

            async function get_data() {
                const arrow = localStorage.getItem(URL);
                if (arrow !== null) {
                    console.log("Using cached data from localStorage");
                    try {
                        const buffer = fflate.strToU8(arrow, true);
                        const table = await WORKER.table(fflate.decompressSync(buffer).buffer);
                        return await processData(table);
                    } catch (e) {
                        console.error("Can't load cached data", e);
                        localStorage.clear();
                    }
                }

                console.log("Loading MTA data");
                const resp = await fetch(URL);
                const csv = await resp.text();
                const table = await WORKER.table(csv);
                
                // Process the data to add coordinates
                const processedTable = await processData(table);
                
                (async () => {
                    console.log("Caching data");
                    const view = await processedTable.view();
                    const arrow = await view.to_arrow();
                    try {
                        const x = fflate.compressSync(new Uint8Array(arrow));
                        const zipped = fflate.strFromU8(x, true);
                        localStorage.setItem(URL + "_processed", zipped);
                    } catch (e) {
                        console.error("Can't cache processed data", e);
                    }
                })();

                return processedTable;
            }

            async function load() {
                const el = document.getElementsByTagName("perspective-viewer")[0];

                const data = get_data();
                const layout_json = await fetch("layout_map.json");
                const layout = await layout_json.json();

                el.load(await data);
                el.restore(layout);
            }

            load();
        </script>

        <style>
            perspective-viewer {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
            
            .title {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1000;
                background-color: rgba(255, 255, 255, 0.8);
                padding: 5px 10px;
                border-radius: 4px;
                font-family: Arial, sans-serif;
            }
        </style>
    </head>

    <body>
        <div class="title">
            <h2>NYC Traffic Congestion Map</h2>
        </div>
        <perspective-viewer editable> </perspective-viewer>
    </body>
</html> 